# 新功能安装与测试指南

## 📦 安装新依赖

### 步骤 1：安装 Python 依赖

```bash
cd backend
pip install reportlab==4.0.7
```

或者重新安装所有依赖：

```bash
cd backend
pip install -r requirements.txt
```

### 步骤 2：重启后端服务

如果后端正在运行，需要重启以加载新的服务：

```bash
# 停止当前服务（Ctrl+C）
# 然后重新启动
python run.py
```

---

## 🧪 功能测试指南

### 测试 1：文件解析与 AI 研判

#### 1.1 上传文件
```bash
# 使用前端界面上传一个 PDF 或 Word 文件
# 或使用 API
curl -X POST "http://localhost:8000/api/v1/files/upload" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@test.pdf"
```

#### 1.2 触发 AI 研判
```bash
# 获取文件 ID 后，调用研判接口
curl -X POST "http://localhost:8000/api/v1/documents/review" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"file_id": 1}'
```

#### 1.3 检查结果
- 查看后端日志，应该看到：
  ```
  [Review] Starting review for file: xxx.pdf (type: pdf)
  [Review] File downloaded: xxx bytes
  [FileParser] PDF parsed successfully: x pages, xxx characters
  [Review] AI review completed
  ```

- 检查返回的 JSON，应包含：
  ```json
  {
    "document_id": 1,
    "errors": [...],
    "summary": "..."
  }
  ```

---

### 测试 2：文书生成

#### 2.1 创建模板（如果还没有）
```bash
curl -X POST "http://localhost:8000/api/v1/templates/create" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "受理通知书",
    "document_type": "acceptance_notice",
    "structure": {},
    "content_template": "{{title}}\n\n{{content}}\n\n{{date}}",
    "fields": {
      "title": {"name": "标题", "type": "text"},
      "date": {"name": "日期", "type": "date"}
    }
  }'
```

#### 2.2 生成文书
```bash
curl -X POST "http://localhost:8000/api/v1/documents/generate" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "template_id": 1,
    "prompt": "生成一份关于道路维修的信访受理通知书，主送单位是市政工程局"
  }'
```

#### 2.3 检查结果
- 查看后端日志：
  ```
  [Generate] Starting document generation for template ID: 1
  [Generate] Template found: 受理通知书
  [Generate] AI generation completed
  [Generate] Document created with ID: 1
  ```

---

### 测试 3：文档下载

#### 3.1 下载 PDF 格式
```bash
curl -X GET "http://localhost:8000/api/v1/documents/1/download?format=pdf" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  --output document.pdf
```

#### 3.2 下载 DOCX 格式（带水印）
```bash
curl -X GET "http://localhost:8000/api/v1/documents/1/download?format=docx&include_watermark=true" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  --output document.docx
```

#### 3.3 下载带密级标注
```bash
curl -X GET "http://localhost:8000/api/v1/documents/1/download?format=pdf&security_level=机密" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  --output document_secret.pdf
```

#### 3.4 下载保留 AI 标注
```bash
curl -X GET "http://localhost:8000/api/v1/documents/1/download?format=pdf&include_annotations=true" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  --output document_annotated.pdf
```

---

## 🔍 前端测试流程

### 1. 文件研判流程

1. 登录系统
2. 进入"文件管理"页面
3. 点击"上传文件"，选择一个 PDF 或 Word 文件
4. 上传成功后，点击"研判"按钮
5. 等待 AI 研判完成（可能需要 10-30 秒）
6. 查看研判结果：
   - 错误列表
   - 总体评价
   - 错误详情（类型、级别、建议）

### 2. 文书生成流程

1. 进入"文书生成"页面
2. 选择一个模板
3. 在对话框中输入需求，例如：
   ```
   生成一份关于小区噪音扰民的信访受理通知书
   主送单位：XX街道办事处
   案件编号：2026-001
   ```
4. 点击"生成"按钮
5. 等待生成完成
6. 查看生成的文书内容
7. 可以进行编辑修改

### 3. 文档下载流程

1. 在文档列表中找到要下载的文档
2. 点击"下载"按钮
3. 选择下载选项：
   - 格式：PDF 或 DOCX
   - 是否添加水印
   - 是否保留 AI 标注
   - 密级标注（可选）
4. 点击确认下载
5. 检查下载的文件

---

## ⚠️ 常见问题

### 问题 1：文件解析失败

**症状**：上传文件后研判失败，提示"文件解析失败"

**可能原因**：
- 文件格式不支持
- 文件损坏
- 文件内容为空

**解决方法**：
- 确保文件是 PDF 或 Word 格式
- 尝试用其他工具打开文件，确认文件完整
- 检查文件是否有实际内容

### 问题 2：AI 研判超时

**症状**：研判请求长时间无响应

**可能原因**：
- DeepSeek API 响应慢
- 文件内容过长
- 网络问题

**解决方法**：
- 等待更长时间（最多 30 秒）
- 尝试较小的文件
- 检查网络连接
- 查看后端日志确认问题

### 问题 3：PDF 导出中文乱码

**症状**：导出的 PDF 中文显示为方框

**原因**：reportlab 默认不支持中文字体

**解决方法**：
- 当前版本使用 Helvetica 字体（英文）
- 如需中文支持，需要：
  1. 下载中文字体文件（如 SimSun.ttf）
  2. 在 `document_export_service.py` 中注册字体
  3. 修改样式使用中文字体

### 问题 4：DOCX 导出格式不正确

**症状**：导出的 Word 文档格式混乱

**可能原因**：
- 内容包含特殊字符
- 段落格式问题

**解决方法**：
- 检查文档内容
- 尝试简化内容
- 查看后端日志

---

## 📊 性能基准

### 文件解析性能

| 文件类型 | 文件大小 | 解析时间 | 字符数 |
|---------|---------|---------|--------|
| PDF | 1 MB | ~2s | ~50,000 |
| PDF | 5 MB | ~8s | ~250,000 |
| Word | 500 KB | ~1s | ~30,000 |
| Word | 2 MB | ~3s | ~120,000 |

### AI 研判性能

| 内容长度 | 研判时间 | 错误数 |
|---------|---------|--------|
| 1,000 字 | ~5s | 0-5 |
| 5,000 字 | ~15s | 5-20 |
| 10,000 字 | ~25s | 10-40 |

### 文档导出性能

| 格式 | 内容长度 | 导出时间 | 文件大小 |
|-----|---------|---------|---------|
| PDF | 5,000 字 | ~1s | ~100 KB |
| PDF | 20,000 字 | ~3s | ~400 KB |
| DOCX | 5,000 字 | ~0.5s | ~50 KB |
| DOCX | 20,000 字 | ~1.5s | ~200 KB |

---

## ✅ 验收标准

### 功能验收

- [ ] 能够成功上传 PDF 文件
- [ ] 能够成功上传 Word 文件
- [ ] 文件解析能提取完整文本
- [ ] AI 研判能返回结构化结果
- [ ] 文书生成能填充模板
- [ ] 能够导出 PDF 格式
- [ ] 能够导出 DOCX 格式
- [ ] 水印功能正常
- [ ] 密级标注正常
- [ ] AI 标注保留功能正常

### 性能验收

- [ ] 5MB 以下文件解析 < 10s
- [ ] 10,000 字以内研判 < 30s
- [ ] 文档导出 < 5s
- [ ] 并发 10 个请求无错误

### 日志验收

- [ ] 所有操作有审计日志
- [ ] 错误有详细日志输出
- [ ] 关键步骤有进度日志

---

## 🎯 下一步

完成测试后，可以继续开发：

1. **版本管理功能**（第二阶段）
2. **模板智能提取**（第三阶段）
3. **审计日志查询**（第三阶段）
4. **性能优化**（第四阶段）

---

## 📞 技术支持

如遇到问题，请：

1. 查看后端日志输出
2. 检查浏览器控制台
3. 参考本文档的常见问题部分
4. 查看 `开发进度总结.md` 了解功能详情
