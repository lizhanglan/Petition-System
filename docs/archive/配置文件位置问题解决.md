# 配置文件位置问题解决

## 🐛 问题

### 现象
- 修改了根目录的 `.env` 文件
- 但配置没有生效
- API 超时还是 30 秒

### 根本原因
**项目有两个 `.env` 文件**：
1. **根目录**：`.env`（前端使用）
2. **backend 目录**：`backend/.env`（后端使用）✅

后端代码读取的是 `backend/.env`，而不是根目录的 `.env`！

---

## ✅ 解决方案

### 修改正确的配置文件

**文件**：`backend/.env`（不是根目录的 `.env`）

```env
# API 调用配置
API_RETRY_TIMES=3
API_RETRY_DELAYS=1000,2000,4000
API_TIMEOUT=120  # 修改这里
```

### 重启后端服务

```bash
# 停止服务（Ctrl+C）
# 重新启动
cd backend
python run.py
```

### 验证配置

```bash
cd backend
python test_config.py
```

**预期输出**：
```
✅ API_TIMEOUT 配置正确（120 秒）
```

---

## 📁 项目结构

```
智能信访/
├── .env                    # 前端配置（不影响后端）
├── backend/
│   ├── .env               # 后端配置 ✅ 这个才是关键
│   ├── app/
│   │   └── core/
│   │       └── config.py  # 读取 backend/.env
│   └── run.py
└── frontend/
```

---

## 🔍 为什么有两个 .env 文件？

### 1. 根目录 .env
- **用途**：前端环境变量、全局配置
- **读取者**：前端构建工具（Vite）
- **不影响**：后端 Python 代码

### 2. backend/.env
- **用途**：后端环境变量
- **读取者**：Python Pydantic Settings
- **影响**：所有后端配置

### 配置读取逻辑

**backend/app/core/config.py**：
```python
class Settings(BaseSettings):
    API_TIMEOUT: int = 120
    
    class Config:
        env_file = ".env"  # 相对于 backend/ 目录
        case_sensitive = True

settings = Settings()
```

当代码运行在 `backend/` 目录时，`.env` 指的是 `backend/.env`。

---

## ✅ 验证步骤

### 1. 检查配置文件

```bash
# 检查后端配置
cat backend/.env | grep API_TIMEOUT

# 应该显示
API_TIMEOUT=120
```

### 2. 验证配置加载

```bash
cd backend
python test_config.py
```

### 3. 重启服务

```bash
cd backend
python run.py
```

### 4. 测试 AI 研判

1. 上传文件
2. 点击"开始研判"
3. 等待 1-2 分钟
4. 应该成功返回结果

---

## 🎯 最佳实践

### 1. 统一配置管理

**建议**：只使用 `backend/.env`，删除或忽略根目录的 `.env`

```bash
# 删除根目录的 .env（如果不需要）
rm .env

# 或者在 .gitignore 中明确说明
echo "/.env" >> .gitignore
echo "/backend/.env" >> .gitignore
```

### 2. 配置文档化

在 `README.md` 中明确说明：
```markdown
## 配置文件

- `backend/.env` - 后端配置（必需）
- 前端配置在 `frontend/.env`（如果需要）
```

### 3. 配置模板

提供配置模板文件：
```bash
# 创建模板
cp backend/.env backend/.env.example

# 在 .env.example 中使用占位符
API_TIMEOUT=120  # API 超时时间（秒）
```

---

## 📝 相关文件

1. **backend/.env** - 后端配置文件（已修改）✅
2. **.env** - 根目录配置文件（前端用）
3. **backend/app/core/config.py** - 配置类定义
4. **backend/test_config.py** - 配置验证脚本

---

## ✅ 验收标准

- [x] `backend/.env` 中 `API_TIMEOUT=120`
- [x] 配置验证脚本显示 120 秒
- [x] 后端服务已重启
- [x] AI 研判功能正常工作
- [x] 不再出现 30 秒超时错误

---

## 🎉 总结

### 问题
- 修改了错误的配置文件（根目录 `.env`）
- 后端读取的是 `backend/.env`

### 解决
- 修改 `backend/.env` 文件
- 设置 `API_TIMEOUT=120`
- 重启后端服务

### 结果
- ✅ 配置正确加载（120 秒）
- ✅ AI 研判功能正常
- ✅ 可以处理长文本

---

**问题状态**：✅ 已解决  
**解决日期**：2026-01-02  
**关键点**：修改正确的配置文件（backend/.env）
