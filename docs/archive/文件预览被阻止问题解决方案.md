# 文件预览被阻止问题解决方案

## 🐛 问题描述

### 现象
- 预览区域显示"此页面已被 Microsoft Edge 阻止"
- Word 文档无法预览
- 浏览器安全策略阻止 iframe 加载

### 问题原因

1. **华为云预览服务失败**
   - API 调用失败
   - 网络问题
   - 服务暂时不可用

2. **Microsoft Office Online Viewer 限制**
   - 需要公网可访问的 URL
   - MinIO 可能使用内网地址（如 124.70.74.202）
   - 浏览器安全策略阻止跨域 iframe

3. **浏览器安全策略**
   - Mixed Content（混合内容）阻止
   - CORS（跨域资源共享）限制
   - iframe sandbox 限制

---

## ✅ 解决方案

### 方案 1：移除 Microsoft Office Online Viewer 降级方案（已实施）

**原因**：
- Microsoft Office Online Viewer 需要公网 URL
- 内网 MinIO 地址无法被访问
- 容易被浏览器安全策略阻止

**实施**：
```python
# backend/app/api/v1/endpoints/files.py

if file.file_type in ['doc', 'docx']:
    preview_url = await office_preview_service.get_preview_url(file_url)
    
    if preview_url:
        preview_type = "huawei"
        print(f"[Preview] 使用华为云预览服务")
    else:
        # 不使用 Microsoft Office Online Viewer
        print(f"[Preview] 华为云服务不可用，Word 文档暂不支持预览")
        preview_url = None
        preview_type = "unsupported"
```

---

### 方案 2：改进前端提示（已实施）

**返回更多信息**：
```python
return {
    "preview_url": preview_url,
    "file_url": file_url,
    "preview_type": preview_type,  # direct, huawei, unsupported
    "file_type": file.file_type,
    "file_name": file.file_name
}
```

**前端根据类型显示不同提示**：
```typescript
const getPreviewErrorMessage = () => {
  if (previewType.value === 'unsupported') {
    if (fileType.value === 'docx' || fileType.value === 'doc') {
      return 'Word 文档预览服务暂时不可用\n您可以下载文件查看，或直接进行 AI 研判'
    }
    return '该文件格式暂不支持在线预览\n您可以下载文件查看，或直接进行 AI 研判'
  }
  return '预览加载失败\n您可以下载文件查看，或直接进行 AI 研判'
}
```

---

### 方案 3：提供下载和重试选项（已实施）

```vue
<el-empty :description="getPreviewErrorMessage()">
  <el-space>
    <el-button type="primary" @click="downloadFile">
      <el-icon><Download /></el-icon>
      下载文件
    </el-button>
    <el-button @click="loadPreview">
      <el-icon><Refresh /></el-icon>
      重新加载
    </el-button>
  </el-space>
</el-empty>
```

---

## 🔧 技术细节

### 预览类型说明

| 类型 | 说明 | 适用文件 | 依赖服务 |
|-----|------|---------|---------|
| `direct` | 直接预览 | PDF | 浏览器内置 |
| `huawei` | 华为云预览 | Word, Excel, PPT | 华为云 API |
| `unsupported` | 不支持预览 | Word（华为云失败时） | 无 |

### 预览流程

```
用户上传文件
  ↓
获取文件信息
  ↓
判断文件类型
  ↓
├─ PDF/Word → 尝试华为云预览
│   ├─ 成功 → 华为云预览
│   └─ 失败 → 
│       ├─ PDF → 浏览器直接预览（降级）
│       └─ Word → 不支持预览（提示下载）
└─ 其他 → 不支持预览
```

### 预览优先级

1. **华为云预览服务**（最优）
   - 支持：PDF, Word, Excel, PPT
   - 优点：功能强大，格式保留好
   - 缺点：需要 API 调用，可能失败

2. **浏览器直接预览**（PDF 降级方案）
   - 支持：PDF
   - 优点：无需第三方服务，速度快
   - 缺点：仅支持 PDF

3. **不支持预览**（Word 降级方案）
   - 提示用户下载文件查看
   - AI 研判功能不受影响

### 为什么不使用 Microsoft Office Online Viewer？

1. **需要公网 URL**
   - MinIO 使用内网地址（124.70.74.202）
   - Microsoft 服务器无法访问内网地址
   - 需要配置公网域名和 SSL 证书

2. **浏览器安全限制**
   - Mixed Content 警告
   - CORS 跨域问题
   - iframe sandbox 限制

3. **用户体验差**
   - 加载慢
   - 容易被阻止
   - 错误提示不友好

---

## 🎯 最佳实践

### 当前方案（推荐）

1. **PDF 文件**
   - ✅ 优先使用华为云预览
   - ✅ 华为云失败时降级到浏览器预览
   - ✅ 速度快，体验好

2. **Word 文件**
   - ✅ 优先使用华为云预览
   - ✅ 失败时提示下载
   - ✅ 不影响 AI 研判功能

3. **其他文件**
   - ✅ 提示不支持预览
   - ✅ 提供下载选项
   - ✅ 可以进行 AI 研判

---

## 🚀 进一步优化建议

### 短期优化（已完成）
- [x] 移除 Microsoft Office Online Viewer
- [x] 改进错误提示
- [x] 添加下载和重试按钮
- [x] 返回预览类型信息

### 中期优化
1. **配置公网访问**
   - 配置公网域名
   - 配置 SSL 证书
   - 配置 MinIO 公网访问
   - 重新启用 Microsoft Office Online Viewer

2. **使用其他预览服务**
   - Google Docs Viewer
   - 其他第三方预览服务
   - 自建预览服务

### 长期优化
1. **客户端预览**
   - 使用 docx-preview.js 预览 Word
   - 使用 PDF.js 预览 PDF
   - 使用 SheetJS 预览 Excel
   - 完全在浏览器端处理

2. **服务端转换**
   - 使用 LibreOffice 转换为 PDF
   - 使用 OnlyOffice 预览
   - 使用 Pandoc 转换格式

---

## 📊 测试结果

### 测试场景

| 文件类型 | 华为云状态 | 预览结果 | 用户体验 |
|---------|-----------|---------|---------|
| PDF | ✅ 可用 | ✅ 华为云预览 | 优秀 |
| PDF | ❌ 不可用 | ✅ 浏览器预览 | 良好 |
| Word | ✅ 可用 | ✅ 华为云预览 | 优秀 |
| Word | ❌ 不可用 | ⚠️ 提示下载 | 可接受 |
| Excel | - | ⚠️ 提示下载 | 可接受 |

### 预期行为
- ✅ PDF 文件优先使用华为云预览
- ✅ PDF 华为云失败时降级到浏览器预览
- ✅ Word 文件优先使用华为云预览
- ✅ Word 华为云失败时显示友好提示
- ✅ 提供下载和重试选项
- ✅ AI 研判功能不受影响

---

## 🔍 故障排查

### 如果华为云预览失败

1. **检查华为云配置**
   ```bash
   # 查看 .env 文件
   OFFICE_HTTP=...
   OFFICE_API_KEY=...
   OFFICE_APP_SECRET=...
   OFFICE_MCP_APP_CODE=...
   OFFICE_X_APIG_APP_CODE=...
   ```

2. **检查网络连接**
   - 测试到华为云 API 的连接
   - 检查防火墙设置
   - 确认 API Key 有效

3. **查看后端日志**
   ```bash
   # 查看详细的预览服务日志
   [Preview Service] Requesting preview for URL: ...
   [Preview Service] Response status: ...
   [Preview Service] Success/Error: ...
   ```

### 如果需要使用 Microsoft Office Online Viewer

1. **配置公网访问**
   - 购买域名
   - 配置 SSL 证书
   - 配置 MinIO 公网访问

2. **修改代码**
   ```python
   # 确保 file_url 是公网可访问的 HTTPS URL
   if not preview_url and file_url.startswith('https://'):
       preview_url = f"https://view.officeapps.live.com/op/embed.aspx?src={file_url}"
   ```

---

## 📝 相关文档

- `Word文档预览问题分析与解决方案.md` - Word 预览参数问题
- `华为云预览服务错误处理方案.md` - 华为云错误处理
- `backend/app/api/v1/endpoints/files.py` - 预览接口实现
- `frontend/src/views/Review.vue` - 前端预览组件

---

## ✅ 验收标准

- [x] PDF 文件可以正常预览
- [x] Word 文件使用华为云预览（如果可用）
- [x] 华为云失败时显示友好提示
- [x] 提供下载文件选项
- [x] 提供重新加载选项
- [x] 不再显示"被 Microsoft Edge 阻止"
- [x] AI 研判功能不受影响

---

**问题状态**：✅ 已解决  
**解决日期**：2026-01-02  
**解决方案**：移除 Microsoft Office Online Viewer + 改进提示  
**影响范围**：Word 文档预览（华为云失败时）
