# 本地规则库降级功能 - 快速开始指南

## 🚀 快速开始

本指南帮助你快速了解和使用本地规则库降级功能。

---

## 📋 功能概述

本地规则库降级功能为系统提供了一个可靠的备用方案：

- **自动降级**: AI 服务失败时自动切换到本地规则引擎
- **透明切换**: 用户无感知，系统自动处理
- **智能恢复**: AI 服务恢复后自动切换回正常模式
- **完整监控**: 提供健康状态和性能指标查询

---

## ⚙️ 配置说明

### 环境变量配置

在 `.env` 文件中添加以下配置：

```env
# 降级功能配置
FALLBACK_ENABLED=true                    # 是否启用降级功能
HEALTH_CHECK_INTERVAL=30                 # 健康检查间隔（秒）
AI_HEALTH_TIMEOUT=5                      # AI 健康检查超时时间（秒）
FAILURE_THRESHOLD=3                      # 失败阈值（连续失败次数）
RECOVERY_THRESHOLD=2                     # 恢复阈值（连续成功次数）
LOCAL_VALIDATION_TIMEOUT=3               # 本地验证超时时间（秒）
RULES_CONFIG_PATH=backend/config/validation_rules.json  # 规则配置文件路径
RULES_AUTO_RELOAD=true                   # 是否自动重载规则配置
```

### 配置说明

| 配置项 | 默认值 | 说明 |
|-------|--------|------|
| FALLBACK_ENABLED | true | 是否启用降级功能 |
| HEALTH_CHECK_INTERVAL | 30 | 健康检查间隔（秒），建议 30-60 秒 |
| AI_HEALTH_TIMEOUT | 5 | AI 健康检查超时时间（秒） |
| FAILURE_THRESHOLD | 3 | 连续失败多少次后触发降级 |
| RECOVERY_THRESHOLD | 2 | 连续成功多少次后恢复正常 |
| LOCAL_VALIDATION_TIMEOUT | 3 | 本地验证超时时间（秒） |
| RULES_CONFIG_PATH | backend/config/validation_rules.json | 规则配置文件路径 |
| RULES_AUTO_RELOAD | true | 是否自动重载规则配置 |

---

## 🔧 启动系统

### 1. 安装依赖

```bash
cd backend
pip install -r requirements.txt
```

### 2. 启动服务

```bash
python run.py
```

### 3. 验证启动

查看启动日志，应该看到：

```
✓ 应用启动，跳过数据库初始化
✓ 降级功能已启用
  - 规则配置已加载: 22 个规则
  - 配置文件自动重载已启用
  - 健康监控已启动（间隔: 30秒）
  - 失败阈值: 3 次
  - 恢复阈值: 2 次
```

---

## 🧪 测试功能

### 运行快速测试

```bash
python backend/test_fallback_system.py
```

测试内容：
1. 规则配置加载
2. 规则执行器
3. 本地规则引擎
4. 健康监控服务
5. 性能指标

预期输出：
```
============================================================
本地规则库降级功能 - 快速测试
============================================================

=== 测试1: 规则配置加载 ===
✓ 配置加载成功
  - 规则总数: 22
  - 启用规则: 22
  - 规则模板: 2

=== 测试2: 规则执行器 ===
✓ 规则执行成功
  - 执行规则数: 5
  - 发现问题数: 2

...

============================================================
测试完成: 5 通过, 0 失败
============================================================

🎉 所有测试通过！降级功能核心组件工作正常。
```

---

## 📊 监控系统状态

### 1. 查看健康状态

```bash
curl http://localhost:8000/api/v1/health/status
```

响应示例：
```json
{
  "mode": "normal",
  "ai_service_healthy": true,
  "consecutive_failures": 0,
  "consecutive_successes": 5,
  "last_check_time": "2026-01-02T10:30:00",
  "last_failure_time": null,
  "estimated_recovery": null
}
```

### 2. 查看降级统计

```bash
curl http://localhost:8000/api/v1/health/fallback-stats
```

响应示例：
```json
{
  "total_checks": 120,
  "total_failures": 5,
  "total_fallback_events": 2,
  "total_fallback_duration": 180.5,
  "current_fallback_duration": null,
  "failure_rate": 0.042,
  "uptime_rate": 0.958
}
```

### 3. 简单健康检查

```bash
curl http://localhost:8000/api/v1/health/check
```

响应示例：
```json
{
  "status": "healthy",
  "mode": "normal",
  "ai_service_healthy": true
}
```

---

## 🎛️ 管理规则

### 1. 列出所有规则

```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/api/v1/admin/rules/list
```

### 2. 查看规则性能

```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/api/v1/admin/rules/performance
```

### 3. 禁用规则

```bash
curl -X PUT \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"enabled": false}' \
  http://localhost:8000/api/v1/admin/rules/format_001/toggle
```

### 4. 重载配置

```bash
curl -X POST \
  -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/api/v1/admin/rules/reload
```

---

## 📝 修改规则配置

### 1. 编辑配置文件

编辑 `backend/config/validation_rules.json`：

```json
{
  "version": "1.0",
  "rules": [
    {
      "id": "custom_001",
      "name": "自定义规则",
      "category": "format",
      "priority": 100,
      "enabled": true,
      "critical": false,
      "rule_type": "pattern",
      "parameters": {
        "pattern": "正则表达式",
        "field": "字段名"
      },
      "error_type": "format_error",
      "error_level": "warning",
      "description": "错误描述",
      "suggestion": "修改建议"
    }
  ]
}
```

### 2. 自动重载

如果启用了 `RULES_AUTO_RELOAD=true`，系统会自动检测文件变化并重载配置。

### 3. 手动重载

也可以通过 API 手动触发重载：

```bash
curl -X POST \
  -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/api/v1/admin/rules/reload
```

---

## 🔍 使用场景

### 场景1：正常使用

用户上传文档进行审核：

1. 系统调用 AI 服务进行研判
2. AI 返回详细的审核结果
3. 用户看到完整的问题分析和建议

### 场景2：AI 服务故障

AI 服务出现故障：

1. 健康监控检测到连续 3 次失败
2. 系统自动切换到降级模式
3. 用户上传文档时使用本地规则引擎
4. 用户看到基础的格式和内容检查结果
5. 响应中包含降级通知和预计恢复时间

### 场景3：AI 服务恢复

AI 服务恢复正常：

1. 健康监控检测到连续 2 次成功
2. 系统自动切换回正常模式
3. 后续请求使用 AI 服务
4. 用户体验恢复正常

---

## 📈 性能指标

### 关键指标

- **本地验证响应时间**: < 3秒
- **健康检查间隔**: 30秒
- **降级切换时间**: < 1秒
- **配置重载时间**: < 1秒

### 监控建议

1. **定期检查健康状态**
   - 每 5 分钟检查一次
   - 关注 `mode` 和 `ai_service_healthy`

2. **监控降级频率**
   - 关注 `total_fallback_events`
   - 如果频繁降级，需要检查 AI 服务

3. **监控失败率**
   - 关注 `failure_rate`
   - 正常情况应 < 5%

4. **监控慢规则**
   - 定期查看 `/api/v1/admin/rules/performance`
   - 优化执行时间 > 500ms 的规则

---

## ⚠️ 常见问题

### Q1: 系统启动时提示"健康监控服务未初始化"

**原因**: `FALLBACK_ENABLED` 未设置为 `true`

**解决**: 在 `.env` 文件中设置 `FALLBACK_ENABLED=true`

### Q2: 规则配置修改后没有生效

**原因**: 
- 配置文件格式错误
- 自动重载未启用

**解决**:
1. 检查 JSON 格式是否正确
2. 确认 `RULES_AUTO_RELOAD=true`
3. 手动调用重载 API

### Q3: 降级模式下验证结果不准确

**原因**: 本地规则引擎只能进行基础校验

**解决**: 
- 这是预期行为
- 本地规则引擎是备用方案，不能完全替代 AI
- 等待 AI 服务恢复后重新审核

### Q4: 健康检查频繁失败

**原因**: 
- AI 服务不稳定
- 网络问题
- 超时时间设置过短

**解决**:
1. 检查 AI 服务状态
2. 检查网络连接
3. 适当增加 `AI_HEALTH_TIMEOUT`

---

## 📚 相关文档

- [API 文档](./本地规则库降级功能API文档.md)
- [完成报告](./本地规则库降级功能完成报告.md)
- [开发进度](./本地规则库降级功能开发进度.md)
- [需求规格说明书](../../.kiro/specs/local-rules-fallback/requirements.md)
- [设计文档](../../.kiro/specs/local-rules-fallback/design.md)

---

## 🆘 获取帮助

如果遇到问题：

1. 查看启动日志
2. 检查配置文件
3. 运行测试脚本
4. 查看 API 文档
5. 联系开发团队

---

**文档版本**: 1.0  
**更新时间**: 2026-01-02  
**维护者**: 开发团队
