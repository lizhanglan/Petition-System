# 文书生成对话预览分离优化

## 优化时间
2026-01-03

## 优化目标
实现文书生成功能中对话区和预览区的内容分离：
- **左侧对话区**：显示AI的简要回复、建议、摘要等对话信息
- **右侧预览区**：显示完整的正式Word文档预览

## 实现方案

### 1. AI返回格式规范化

修改 `backend/app/services/deepseek_service.py` 的 `generate_document` 方法，要求AI返回结构化JSON：

```json
{
  "chat_message": "简短的对话回复，告诉用户生成了什么内容（50-100字）",
  "document_content": "完整的文书正文内容",
  "summary": "文书的简要摘要（30-50字）",
  "suggestions": ["建议1", "建议2", "建议3"]
}
```

**字段说明**：
- `chat_message`: 用于左侧对话显示，简明扼要地说明生成的内容
- `document_content`: 完整的文书正文，用于生成Word文档预览
- `summary`: 文书摘要，用于对话中快速了解内容
- `suggestions`: 可选的改进建议列表

### 2. 后端接口改造

修改 `backend/app/api/v1/endpoints/documents.py` 的 `generate_document` 接口：

**主要改动**：
1. 解析AI返回的JSON格式
2. 提取 `document_content` 用于生成Word文档
3. 提取 `chat_message`、`summary`、`suggestions` 返回给前端
4. 添加JSON解析失败的降级逻辑（使用整个返回作为文档内容）
5. 将对话信息存储在 `ai_annotations` 字段中返回

**关键代码**：
```python
# 解析AI返回的JSON格式
try:
    ai_data = json.loads(ai_response)
    chat_message = ai_data.get("chat_message", "")
    document_content = ai_data.get("document_content", "")
    summary = ai_data.get("summary", "")
    suggestions = ai_data.get("suggestions", [])
except json.JSONDecodeError:
    # 降级处理：使用整个返回作为文档内容
    document_content = ai_response
    chat_message = f"已生成文书，共 {len(ai_response)} 字。"

# 添加对话消息（使用chat_message）
conversation_service.add_message(
    user_id=current_user.id,
    role="assistant",
    content=chat_message,
    session_id=request.session_id,
    metadata={
        "content_length": len(document_content),
        "summary": summary,
        "suggestions": suggestions
    }
)

# 返回时包含对话信息
return DocumentResponse(
    ...
    ai_annotations={
        "chat_message": chat_message,
        "summary": summary,
        "suggestions": suggestions
    },
    preview_url=preview_url,
    ...
)
```

### 3. 前端显示优化

修改 `frontend/src/views/Generate.vue`：

**主要改动**：
1. 从 `result.ai_annotations` 中提取 `chat_message`、`summary`、`suggestions`
2. 在对话区显示格式化的消息（包含摘要和建议）
3. 右侧预览区继续显示Word文档iframe
4. 添加 `white-space: pre-wrap` 样式支持多行文本显示

**关键代码**：
```javascript
// 提取AI返回的chat_message和suggestions
let chatMessage = `文书已生成（${result.content.length} 字），请在右侧查看预览。`

if (result.ai_annotations) {
  // 使用AI返回的chat_message
  if (result.ai_annotations.chat_message) {
    chatMessage = result.ai_annotations.chat_message
  }
  
  // 如果有摘要，添加到消息中
  if (result.ai_annotations.summary) {
    chatMessage += `\n\n📝 摘要：${result.ai_annotations.summary}`
  }
  
  // 如果有建议，添加到消息中
  if (result.ai_annotations.suggestions && result.ai_annotations.suggestions.length > 0) {
    chatMessage += '\n\n💡 建议：'
    result.ai_annotations.suggestions.forEach((suggestion, index) => {
      chatMessage += `\n${index + 1}. ${suggestion}`
    })
  }
}

// 添加到对话历史
messages.value.push({
  role: 'assistant',
  content: chatMessage,
  timestamp: new Date().toISOString()
})
```

## 用户体验提升

### 对话区显示示例
```
AI: 已为您生成信访答复文书，内容包含诉求分析、处理意见和答复结论三个部分。

📝 摘要：针对群众反映的道路维修问题，经核实后给予答复和处理方案。

💡 建议：
1. 建议在答复中增加具体的维修时间节点
2. 可以补充相关部门的联系方式
3. 建议添加后续跟进机制说明
```

### 预览区显示
- 显示完整的Word文档预览（通过iframe）
- 包含所有格式、段落、标题等
- 支持在线查看，无需下载

## 容错处理

1. **JSON解析失败**：如果AI返回的不是有效JSON，自动降级使用整个返回作为文档内容
2. **字段缺失**：如果JSON中缺少某些字段，使用默认值
3. **预览失败**：如果预览URL获取失败，在对话中仍然显示生成成功的消息

## 技术优势

1. **内容分离**：对话信息和文档内容完全分离，各司其职
2. **用户友好**：对话区提供简洁的反馈和建议，预览区显示完整文档
3. **可扩展**：JSON格式便于后续添加更多字段（如关键词、标签等）
4. **向后兼容**：降级逻辑确保即使AI返回格式不符合预期也能正常工作

## 相关文件

- `backend/app/services/deepseek_service.py` - AI提示词和格式定义
- `backend/app/api/v1/endpoints/documents.py` - 后端接口逻辑
- `frontend/src/views/Generate.vue` - 前端显示逻辑

## 测试建议

1. 测试正常生成流程，验证对话区和预览区显示正确
2. 测试AI返回非JSON格式时的降级处理
3. 测试建议列表的显示效果
4. 测试多轮对话中的消息累积显示
5. 测试预览URL获取失败时的容错处理
