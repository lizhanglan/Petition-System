# 云服务器部署配置修改说明

**日期**: 2026-01-03  
**状态**: ✅ 已完成

---

## 📋 修改概述

为了支持云服务器Docker部署，对项目配置进行了以下关键修改。

---

## 🔧 已完成的修改

### 1. 前端API地址配置 ✅

**文件**: `frontend/src/api/request.ts`

**修改内容**:
```typescript
// 修改前（硬编码localhost）
baseURL: 'http://localhost:8000/api/v1'

// 修改后（使用相对路径）
baseURL: '/api/v1'
```

**原因**: 
- 使用相对路径可以自动适配域名
- 通过nginx代理访问后端
- 支持开发和生产环境

---

### 2. Vite开发代理配置 ✅

**文件**: `frontend/vite.config.ts`

**添加内容**:
```typescript
server: {
  port: 5173,
  proxy: {
    '/api': {
      target: 'http://localhost:8000',
      changeOrigin: true,
      rewrite: (path) => path
    }
  }
}
```

**原因**: 
- 开发环境下代理API请求到后端
- 避免跨域问题
- 保持开发和生产环境一致

---

### 3. 部署文档 ✅

**新增文件**: `CLOUD_DEPLOYMENT_GUIDE.md`

**内容包括**:
- 部署前检查清单
- 必须修改的配置
- 详细部署步骤
- 安全建议
- 常见问题解决
- 性能优化建议

---

### 4. 自动化部署脚本 ✅

**新增文件**: `deploy-cloud.sh`

**功能**:
- 自动检查Docker环境
- 验证环境变量配置
- 构建和启动服务
- 初始化数据库
- 显示访问信息

**使用方法**:
```bash
chmod +x deploy-cloud.sh
./deploy-cloud.sh
```

---

## ⚠️ 部署前必须修改的配置

### 1. 环境变量（.env文件）

```bash
# 从示例文件创建
cp .env.example .env

# 必须修改以下配置
POSTGRES_PASSWORD=your-strong-password        # 数据库密码
REDIS_PASSWORD=your-strong-redis-password     # Redis密码
MINIO_ROOT_PASSWORD=your-strong-minio-password # MinIO密码
SECRET_KEY=your-32-char-random-secret-key     # JWT密钥
DEEPSEEK_API_KEY=sk-your-actual-api-key       # DeepSeek API
```

### 2. MinIO公网访问（可选但推荐）

**文件**: `backend/.env`

```bash
# 添加MinIO公网地址
MINIO_PUBLIC_URL=http://your-server-ip:9000
```

**修改**: `backend/app/core/minio_client.py`

在 `get_file_url` 方法中替换内网地址为公网地址。

---

## 📊 配置对比

### 开发环境 vs 生产环境

| 配置项 | 开发环境 | 生产环境 |
|--------|---------|---------|
| 前端API地址 | `/api/v1` (Vite代理) | `/api/v1` (Nginx代理) |
| 后端地址 | `localhost:8000` | `backend:8000` (容器内) |
| 数据库地址 | `localhost:5432` | `postgres:5432` (容器内) |
| Redis地址 | `localhost:6379` | `redis:6379` (容器内) |
| MinIO地址 | `localhost:9000` | `minio:9000` (容器内) |
| 前端端口 | `5173` (Vite) | `80` (Nginx) |

---

## 🚀 快速部署流程

### 1. 准备服务器

```bash
# 安装Docker
curl -fsSL https://get.docker.com | sh

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 2. 上传代码

```bash
# 使用git
git clone your-repository-url
cd your-project

# 或使用scp
scp -r ./project user@server:/path/
```

### 3. 配置环境

```bash
# 复制并编辑环境变量
cp .env.example .env
nano .env
```

### 4. 一键部署

```bash
# 使用自动化脚本
chmod +x deploy-cloud.sh
./deploy-cloud.sh

# 或手动部署
docker-compose build
docker-compose up -d
docker exec petition-backend python manual_create_tables.py
docker exec petition-backend python init_standard_templates.py
```

### 5. 验证部署

```bash
# 检查服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 测试访问
curl http://your-server-ip
curl http://your-server-ip/api/v1/health/status
```

---

## 🔒 安全检查清单

部署后请确认：

- [ ] 修改了所有默认密码
- [ ] 配置了强密码（至少16位）
- [ ] 配置了JWT密钥（至少32位）
- [ ] 配置了DeepSeek API密钥
- [ ] 关闭了不必要的端口
- [ ] 配置了防火墙规则
- [ ] 启用了HTTPS（如果有域名）
- [ ] 配置了数据备份
- [ ] 设置了日志轮转
- [ ] 测试了所有功能

---

## 📝 Docker配置文件说明

### docker-compose.yml

**当前配置**: ✅ 已优化，适合生产环境

**特点**:
- 5个服务容器（frontend, backend, postgres, redis, minio）
- 健康检查配置
- 数据持久化
- 网络隔离
- 自动重启

**无需修改**: 配置已经适合云服务器部署

### backend/Dockerfile

**当前配置**: ✅ 已优化

**特点**:
- Python 3.11基础镜像
- 多阶段构建（可选优化）
- 健康检查
- 日志目录

**无需修改**: 配置已经适合生产环境

### frontend/Dockerfile

**当前配置**: ✅ 已优化

**特点**:
- 多阶段构建（builder + nginx）
- 生产环境优化
- Nginx配置
- 健康检查

**无需修改**: 配置已经适合生产环境

### frontend/nginx.conf

**当前配置**: ✅ 已优化

**特点**:
- API代理配置
- Gzip压缩
- 静态资源缓存
- 安全头配置

**可选优化**: 添加HTTPS配置（如果有SSL证书）

---

## 🐛 常见问题

### Q1: 前端无法访问后端API

**A**: 检查以下配置：
1. `frontend/src/api/request.ts` 使用相对路径 `/api/v1`
2. `frontend/nginx.conf` 代理配置正确
3. 重新构建前端镜像

### Q2: MinIO文件无法访问

**A**: 配置MinIO公网地址：
1. 在 `.env` 中添加 `MINIO_PUBLIC_URL`
2. 修改 `minio_client.py` 使用公网地址
3. 确保9000端口可以公网访问

### Q3: 数据库连接失败

**A**: 检查以下内容：
1. `.env` 中的数据库密码正确
2. 等待数据库健康检查通过
3. 查看数据库日志

---

## 📚 相关文档

- **CLOUD_DEPLOYMENT_GUIDE.md** - 详细部署指南
- **DOCKER_DEPLOY.md** - Docker部署文档
- **DEPLOY_QUICK_START.md** - 快速开始指南
- **DEPLOYMENT_CHECKLIST.md** - 部署检查清单

---

## ✅ 验收标准

部署成功的标志：

- [x] 所有容器正常运行
- [x] 前端可以访问（http://server-ip）
- [x] 后端API可以访问（http://server-ip/api/v1）
- [x] 可以登录系统
- [x] 可以上传文件
- [x] 可以生成文书
- [x] 文件预览正常
- [x] 所有功能正常工作

---

**修改完成时间**: 2026-01-03  
**修改人**: Kiro AI Assistant  
**状态**: ✅ 已完成，可以部署到云服务器
