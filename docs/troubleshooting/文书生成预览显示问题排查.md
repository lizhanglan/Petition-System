# 文书生成预览显示问题排查

**日期**: 2026-01-03  
**问题**: 生成文书后预览应显示正式Word文档，而不是纯文本  
**状态**: 已实现Word预览，需要验证

---

## 当前实现

### 后端实现（已完成）

**文件**: `backend/app/api/v1/endpoints/documents.py`

**生成流程**:
```python
# 1. AI生成文书内容
generated_content = await deepseek_service.generate_document(...)

# 2. 填充模板
final_content = _fill_template(template.content_template, structured_content, generated_content)

# 3. 创建文档记录
document = Document(
    user_id=current_user.id,
    template_id=template.id,
    title=f"{template.name}_{datetime.now().strftime('%Y%m%d%H%M%S')}",
    content=final_content,
    ...
)

# 4. 生成DOCX文件
docx_bytes = await document_export_service.export_to_docx(
    content=final_content,
    title=document.title,
    options={"document_type": document.document_type}
)

# 5. 上传到MinIO
temp_filename = f"temp_preview/{current_user.id}/{document.id}.docx"
await minio_client.upload_file(temp_filename, docx_bytes, "application/vnd.openxmlformats-officedocument.wordprocessingml.document")

# 6. 获取预览URL（优先WPS，降级到华为云）
file_url = minio_client.get_file_url(temp_filename, expires=3600, inline=True)
preview_result = await preview_service_selector.get_preview_url(
    file_url=file_url,
    file_name=f"{document.title}.docx",
    user_id=str(current_user.id),
    permission="read"
)

preview_url = preview_result.get("preview_url") if preview_result else None

# 7. 返回给前端
return DocumentResponse(
    id=document.id,
    title=document.title,
    content=document.content,
    document_type=document.document_type,
    status=document.status,
    ai_annotations=document.ai_annotations,
    preview_url=preview_url,  # ← 关键：返回预览URL
    created_at=document.created_at
)
```

### 前端实现（已完成）

**文件**: `frontend/src/views/Generate.vue`

**显示逻辑**:
```vue
<!-- 文档预览iframe -->
<div v-if="previewUrl" class="document-preview">
  <iframe 
    :src="previewUrl" 
    frameborder="0" 
    width="100%" 
    height="100%"
    style="border-radius: 4px;"
  ></iframe>
</div>
<el-empty v-else description="暂无生成内容">
  <template #image>
    <el-icon :size="60"><Document /></el-icon>
  </template>
  <template #description>
    <p>请在左侧输入需求并生成文书</p>
    <p style="font-size: 12px; color: #999; margin-top: 5px;">
      生成后将在此处显示文档预览
    </p>
  </template>
</el-empty>
```

**接收逻辑**:
```typescript
const result: any = await generateDocument({...})

// 获取预览URL
if (result.preview_url) {
  previewUrl.value = result.preview_url
  console.log('[Generate] Preview URL:', result.preview_url)
} else {
  // 如果没有返回，尝试获取
  const previewResponse = await fetch(`/api/v1/documents/${result.id}/preview`)
  const previewData = await previewResponse.json()
  if (previewData.preview_url) {
    previewUrl.value = previewData.preview_url
  }
}
```

---

## 预览服务流程

### 当前配置
```bash
WPS_ENABLED=false  # WPS暂时禁用
```

### 预览流程
```
生成文书
    ↓
导出为DOCX
    ↓
上传到MinIO
    ↓
获取文件URL
    ↓
PreviewServiceSelector
    ↓
尝试WPS服务（跳过，未启用）
    ↓
使用华为云服务 ✓
    ↓
返回preview_url
    ↓
前端iframe显示
```

---

## 验证步骤

### 1. 检查后端日志
生成文书时应该看到：
```
[Generate] Starting document generation for template ID: 1
[Generate] AI generation completed, content length: 523
[Generate] Document created with ID: 7, version 1 created
[PreviewSelector] 使用华为云预览服务...
[Preview Service] Response status: 200
[Preview Service] Success: https://view.chigua.ren/...
[PreviewSelector] 华为云服务成功
[Generate] Preview service: huawei, URL: https://...
```

### 2. 检查前端控制台
应该看到：
```
[Generate] Preview URL: https://view.chigua.ren/v2/api?view=...
```

### 3. 检查网络请求
- 生成文书请求：`POST /api/v1/documents/generate`
- 响应应包含：`preview_url` 字段

### 4. 检查iframe
- iframe的src应该是华为云预览URL
- 应该能看到Word文档预览

---

## 可能的问题

### 问题1: preview_url为空

**症状**: 前端显示"暂无生成内容"

**原因**:
1. 后端生成preview_url失败
2. 华为云服务不可用
3. MinIO文件URL无法访问

**排查**:
```bash
# 查看后端日志
docker-compose logs backend | grep -i "preview"

# 检查MinIO
curl http://124.70.74.202:9000

# 检查华为云服务
# 查看日志中的华为云响应
```

**解决**:
- 确保MinIO可以公网访问
- 确保华为云服务配置正确
- 检查网络连接

### 问题2: iframe显示空白

**症状**: iframe加载但显示空白

**原因**:
1. 预览URL已过期
2. 跨域问题
3. 华为云服务返回错误

**排查**:
```javascript
// 在浏览器控制台
console.log(previewUrl.value)
// 复制URL在新标签页打开，查看是否能正常显示
```

**解决**:
- 增加URL有效期
- 配置CORS
- 检查华为云服务状态

### 问题3: 显示纯文本而不是Word

**症状**: 看到的是文本内容，不是格式化的Word文档

**原因**:
1. 没有使用iframe显示
2. preview_url为空，显示了content字段
3. 前端逻辑错误

**排查**:
```vue
<!-- 检查模板 -->
<div v-if="previewUrl">  <!-- 应该进入这个分支 -->
  <iframe :src="previewUrl" />
</div>
<div v-else>  <!-- 不应该进入这个分支 -->
  纯文本显示
</div>
```

**解决**:
- 确保preview_url有值
- 确保使用iframe显示
- 不要直接显示content字段

---

## 正确的显示效果

### 应该看到
- ✅ 左侧：对话历史
- ✅ 右侧：Word文档预览（iframe）
- ✅ 文档格式完整（标题、正文、落款等）
- ✅ 可以滚动查看完整文档

### 不应该看到
- ❌ 纯文本内容
- ❌ JSON格式
- ❌ 空白页面
- ❌ 错误提示

---

## 测试用例

### 测试1: 基本生成
```
1. 选择模板
2. 输入需求："生成一份关于XX的文书"
3. 点击发送
4. 等待生成完成
5. 验证：右侧显示Word文档预览
```

### 测试2: 多轮对话
```
1. 生成第一份文书
2. 继续输入："请修改标题为XX"
3. 点击发送
4. 验证：预览更新为新的文档
```

### 测试3: 文件引用
```
1. 点击"引用文件"
2. 选择一个已上传的文件
3. 输入需求："参考这个文件生成文书"
4. 点击发送
5. 验证：生成的文书包含参考内容
```

---

## 调试命令

### 查看后端日志
```bash
# 查看生成相关日志
docker-compose logs backend | grep -i "generate"

# 查看预览相关日志
docker-compose logs backend | grep -i "preview"

# 查看错误日志
docker-compose logs backend | grep -i "error"
```

### 测试API
```bash
# 测试生成接口
curl -X POST http://localhost:8000/api/v1/documents/generate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "template_id": 1,
    "prompt": "生成一份测试文书"
  }'

# 测试预览接口
curl http://localhost:8000/api/v1/documents/1/preview \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## 相关文件

- `backend/app/api/v1/endpoints/documents.py` - 文书生成接口
- `backend/app/services/document_export_service.py` - 文档导出服务
- `backend/app/services/preview_service_selector.py` - 预览服务选择器
- `frontend/src/views/Generate.vue` - 文书生成页面

---

## 总结

系统已经实现了Word文档预览功能：

1. ✅ 后端生成DOCX文件
2. ✅ 上传到MinIO
3. ✅ 获取预览URL（华为云）
4. ✅ 返回给前端
5. ✅ 前端iframe显示

如果看到的是纯文本而不是Word预览，请按照上述步骤排查问题。
