# 重启后端服务说明

## 问题现象
修改后端代码后，访问 API 时出现 Pydantic 验证错误：
```
pydantic_core._pydantic_core.ValidationError: 4 validation errors for RuleStatisticsResponse
total_rules
  Field required [type=missing, ...]
enabled_rules
  Field required [type=missing, ...]
disabled_rules
  Field required [type=missing, ...]
rules_by_category
  Field required [type=missing, ...]
```

## 原因
后端代码已更新，但服务器仍在运行旧代码。Python 不会自动重新加载已修改的模块。

## 解决方案

### 方法 1: 重启后端服务（推荐）

#### Windows (使用 start.bat)
1. 在当前运行后端的终端按 `Ctrl+C` 停止服务
2. 重新运行：
   ```cmd
   start.bat
   ```

#### 手动启动
1. 在当前运行后端的终端按 `Ctrl+C` 停止服务
2. 重新运行：
   ```cmd
   cd backend
   python run.py
   ```

### 方法 2: 使用开发模式自动重载

如果使用 uvicorn 的 `--reload` 选项，代码修改后会自动重载。

修改 `backend/run.py`：
```python
if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        "app.main:app",
        host="0.0.0.0",
        port=8000,
        reload=True  # 启用自动重载
    )
```

**注意**: 自动重载仅适用于开发环境，生产环境不应使用。

## 验证服务已重启

重启后，查看终端输出，应该看到：
```
INFO:     Started server process [进程ID]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

## 常见问题

### Q1: 按 Ctrl+C 后服务没有停止
A: 
- Windows: 打开任务管理器，结束 python.exe 进程
- 或者关闭终端窗口，重新打开一个新的终端

### Q2: 重启后仍然报错
A: 检查以下几点：
1. 确认所有修改的文件都已保存
2. 确认没有语法错误（查看终端输出）
3. 清除 Python 缓存：删除 `backend/__pycache__` 和 `backend/app/__pycache__` 目录
4. 重新启动

### Q3: 如何确认代码已更新？
A: 在代码中添加日志输出，重启后查看日志：
```python
logger.info(f"Statistics: total={total_rules}, enabled={enabled_count}, disabled={disabled_count}")
```

## 本次修复需要重启的原因

修改了以下文件：
1. `backend/app/services/local_rules_engine.py` - 更新了 `get_rule_statistics()` 方法
2. `backend/app/api/v1/endpoints/admin.py` - 更新了 `RuleStatisticsResponse` 模型

这些是核心业务逻辑文件，必须重启服务才能生效。

## 重启后的预期结果

访问 `/api/v1/admin/rules/statistics` 应该返回：
```json
{
  "config_info": {...},
  "enabled_rules_count": 7,
  "category_statistics": {...},
  "performance_metrics": {...},
  "total_rules": 7,
  "enabled_rules": 7,
  "disabled_rules": 0,
  "rules_by_category": {...}
}
```

规则管理页面的统计卡片应该显示正确的数字。

## 更新日期
2026-01-02
