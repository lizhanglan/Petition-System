# AI生成文书格式修复

## 问题描述

在文书生成预览功能中，AI返回的内容是JSON格式的原始数据，而不是按照公文格式编排的纯文本内容。导致在Word预览中显示的是JSON结构，而不是格式化的公文文本。

### 问题表现

```json
{
  "document_number_rule": "文号格式为：桂警院字(YYYY)XXX号，其中YYYY为年份，XXX为序号。",
  "header": "发文单位名称为广西警察学院，居中。",
  "title_format": "标题格式为：广西警察学院关于给予[学生姓名]同学[处分类型]处分的决定，居中。",
  "closing_format": "落款格式为：广西警察学院 换行 YYYY年MM月DD日，右对齐。"
}
```

## 问题原因

1. **AI Prompt不够明确**：虽然要求返回JSON格式，但`document_content`字段的说明不够清晰，没有强调要输出纯文本而非JSON结构
2. **格式要求不明确**：没有明确说明公文格式的具体要求（段落、缩进、对齐等）

## 解决方案

### 1. 优化AI Prompt

修改`backend/app/services/deepseek_service.py`中的`generate_document`方法，明确要求：

```python
system_prompt = f"""你是信访文书生成专家，严格遵循《党政机关公文格式》规范。

当前使用模板：{template_info.get('name', '未知模板')}
模板类型：{template_info.get('document_type', '未知类型')}

**重要：必须严格按照以下JSON格式返回，不要添加任何其他文字：**

{{
  "chat_message": "简短的对话回复，告诉用户生成了什么内容，有什么特点或建议（50-100字）",
  "document_content": "完整的文书正文内容，按照公文格式编排，包含所有必要的段落",
  "summary": "文书的简要摘要（30-50字）",
  "suggestions": ["建议1", "建议2", "建议3"]
}}

说明：
1. chat_message: 用于左侧对话显示，简明扼要地说明生成的内容
2. document_content: 完整的文书正文，按照标准公文格式编排：
   - 使用换行符分隔段落
   - 标题居中（如需要）
   - 正文段落首行缩进两个全角空格
   - 落款右对齐（使用适当的空格）
   - 日期格式：YYYY年MM月DD日
   - 不要包含JSON格式标记，直接输出纯文本
3. summary: 文书摘要，用于对话中快速了解内容
4. suggestions: 可选的改进建议列表

注意：
- document_content中只包含纯文本内容，不要有JSON标记
- 仅生成正文内容，不包含模板固定格式部分（如文号、页眉等）
- 确保内容合规、语言规范、逻辑清晰
- 段落之间用换行符分隔
- 如发现需求中信息缺失或错误，在chat_message中说明
- 如果用户提供了参考文件，结合参考文件内容生成"""
```

### 2. 关键改进点

1. **明确格式要求**：
   - 使用换行符分隔段落
   - 正文段落首行缩进两个全角空格（　　）
   - 落款右对齐（使用适当的空格）
   - 日期格式标准化

2. **强调纯文本输出**：
   - 明确说明"不要包含JSON格式标记"
   - 强调"直接输出纯文本"

3. **保持JSON结构**：
   - 外层仍然是JSON格式，便于程序解析
   - `document_content`字段内是格式化的纯文本

### 3. 预期输出示例

```json
{
  "chat_message": "已为您生成关于给予董光辉同学留校察看处分的决定，内容包含违纪事实、处理依据和处分决定。",
  "document_content": "广西警察学院关于给予董光辉同学留校察看处分的决定\n\n　　经查，董光辉同学在2024年10月15日晚违反校规校纪，擅自离校外出，且未按规定履行请假手续。该行为违反了《广西警察学院学生管理规定》第二十三条相关规定。\n\n　　根据《普通高等学校学生管理规定》（教育部令第41号）第五十二条和《广西警察学院学生违纪处分办法》第十五条之规定，经学院研究决定，给予董光辉同学留校察看处分，察看期为十二个月。\n\n　　希望董光辉同学深刻反省，认真改正错误，在察看期内严格遵守校规校纪，努力学习，争取早日解除处分。\n\n　　　　　　　　　　　　　　　　　　　　　　广西警察学院\n　　　　　　　　　　　　　　　　　　　　　　2026年1月4日",
  "summary": "对董光辉同学违反校规校纪行为给予留校察看处分的决定",
  "suggestions": [
    "建议补充具体的违纪时间和地点",
    "可以添加申诉途径和期限说明",
    "建议明确察看期的具体要求"
  ]
}
```

## 测试验证

1. **测试场景**：生成一份学生处分决定
2. **验证点**：
   - JSON格式正确解析
   - `document_content`是纯文本，不含JSON标记
   - 文本按照公文格式编排（段落、缩进、对齐）
   - Word预览显示正常

## 相关文件

- `backend/app/services/deepseek_service.py` - AI服务，修改prompt
- `backend/app/api/v1/endpoints/documents.py` - 文书生成API，处理返回结果

## 修复时间

2026-01-04

## 修复人员

Kiro AI Assistant
