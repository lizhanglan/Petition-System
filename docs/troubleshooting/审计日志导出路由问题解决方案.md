# 审计日志导出路由问题解决方案

## 问题描述

**错误信息**:
```
[Vue Router warn]: No match found for location with path "/api/v1/audit-logs/export"
```

**问题原因**:
Vue Router 将后端 API 路径 `/api/v1/audit-logs/export` 当作前端路由来处理，导致路由警告。

---

## 问题分析

### 原始代码问题

**frontend/src/api/auditLogs.ts**:
```typescript
export const exportAuditLogs = (params: any) => {
  const queryString = new URLSearchParams(params).toString()
  return `/api/v1/audit-logs/export?${queryString}`  // ❌ 相对路径
}
```

**frontend/src/views/AuditLogs.vue**:
```typescript
const handleExport = () => {
  const url = exportAuditLogs(params)
  window.open(url, '_blank')  // ❌ Vue Router 会拦截
}
```

### 问题根源

1. `window.open()` 使用相对路径时，Vue Router 会尝试匹配路由
2. 后端 API 路径不在前端路由配置中
3. 导致 Vue Router 警告

---

## 解决方案

### 方案 1：使用完整 URL（推荐）

**修改 frontend/src/api/auditLogs.ts**:
```typescript
export const exportAuditLogs = (params: any) => {
  const filteredParams: any = {}
  Object.entries(params).forEach(([key, value]) => {
    if (value) {
      filteredParams[key] = value
    }
  })
  
  const queryString = new URLSearchParams(filteredParams).toString()
  // ✅ 返回完整的后端 URL
  return `http://localhost:8000/api/v1/audit-logs/export${queryString ? '?' + queryString : ''}`
}
```

### 方案 2：使用 Fetch API 下载（最佳）

**修改 frontend/src/views/AuditLogs.vue**:
```typescript
const handleExport = () => {
  const params: any = { /* ... */ }
  
  // 获取 token
  const authStore = useAuthStore()
  const token = authStore.token
  
  if (!token) {
    ElMessage.error('请先登录')
    return
  }

  // 构建 URL
  const baseUrl = 'http://localhost:8000/api/v1/audit-logs/export'
  const queryString = new URLSearchParams(params).toString()
  const url = `${baseUrl}${queryString ? '?' + queryString : ''}`
  
  // ✅ 使用 fetch 下载，带上 token
  fetch(url, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
    .then(response => {
      if (!response.ok) {
        throw new Error('导出失败')
      }
      return response.blob()
    })
    .then(blob => {
      // 创建下载链接
      const downloadUrl = window.URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = downloadUrl
      a.download = `audit_logs_${new Date().getTime()}.csv`
      document.body.appendChild(a)
      a.click()
      document.body.removeChild(a)
      window.URL.revokeObjectURL(downloadUrl)
      ElMessage.success('导出成功')
    })
    .catch(error => {
      console.error(error)
      ElMessage.error('导出失败')
    })
}
```

---

## 方案对比

| 方案 | 优点 | 缺点 |
|-----|------|------|
| 完整 URL | 简单直接 | 需要硬编码后端地址 |
| Fetch API | 支持认证、错误处理 | 代码稍复杂 |
| window.location.href | 最简单 | 无法带 token、会刷新页面 |

---

## 最佳实践

### 1. 使用 Fetch API 下载文件

**优点**:
- ✅ 支持添加认证 token
- ✅ 可以处理错误响应
- ✅ 不会触发 Vue Router
- ✅ 可以显示下载进度
- ✅ 可以自定义文件名

### 2. 配置环境变量

**创建 .env 文件**:
```env
VITE_API_BASE_URL=http://localhost:8000
```

**使用环境变量**:
```typescript
const baseUrl = `${import.meta.env.VITE_API_BASE_URL}/api/v1/audit-logs/export`
```

### 3. 统一下载工具函数

**创建 utils/download.ts**:
```typescript
import { useAuthStore } from '@/stores/auth'

export const downloadFile = async (url: string, filename: string) => {
  const authStore = useAuthStore()
  const token = authStore.token
  
  if (!token) {
    throw new Error('未登录')
  }

  const response = await fetch(url, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  
  if (!response.ok) {
    throw new Error('下载失败')
  }
  
  const blob = await response.blob()
  const downloadUrl = window.URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = downloadUrl
  a.download = filename
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  window.URL.revokeObjectURL(downloadUrl)
}
```

**使用**:
```typescript
import { downloadFile } from '@/utils/download'

const handleExport = async () => {
  try {
    await downloadFile(url, 'audit_logs.csv')
    ElMessage.success('导出成功')
  } catch (error) {
    ElMessage.error('导出失败')
  }
}
```

---

## 其他类似问题

### 文档下载

**问题**:
```typescript
window.open(`/api/v1/documents/${id}/download`)  // ❌
```

**解决**:
```typescript
const url = `http://localhost:8000/api/v1/documents/${id}/download`
await downloadFile(url, 'document.pdf')  // ✅
```

### 文件预览

**问题**:
```typescript
<iframe :src="`/api/v1/files/${id}/preview`" />  // ❌
```

**解决**:
```typescript
<iframe :src="`http://localhost:8000/api/v1/files/${id}/preview`" />  // ✅
```

---

## 总结

1. **避免使用相对路径访问后端 API**
2. **使用完整 URL 或 Fetch API**
3. **统一下载逻辑，创建工具函数**
4. **使用环境变量管理后端地址**
5. **确保下载请求带上认证 token**

---

**问题解决时间**: 2026-01-02  
**文档版本**: 1.0
