# ONLYOFFICE功能测试指南

**测试时间**: 2026-01-03 22:30  
**前提条件**: 前端集成已完成，服务正在运行  

---

## 🚀 开始测试前的准备

### 1. 确认服务状态

- ✅ 后端服务: http://localhost:8000
- ✅ 前端服务: http://localhost:5173
- ✅ ONLYOFFICE服务: http://101.37.24.171:9090

### 2. 刷新浏览器

由于前端代码已更新，请刷新浏览器：

```
Windows: Ctrl + F5
Mac: Cmd + Shift + R
```

或者清除浏览器缓存后刷新。

### 3. 确认登录状态

- 打开 http://localhost:5173
- 确认已登录（user_id: 2）
- 如果未登录，请先登录

---

## 📋 测试清单

### 测试1: 文件预览功能 ⏳

**目标**: 验证ONLYOFFICE文件预览功能

**步骤**:
1. 进入"文件管理"页面
2. 如果没有文件，先上传一个DOCX文件
3. 点击文件的"预览"按钮
4. 观察预览对话框

**预期结果**:
- ✅ 对话框打开
- ✅ 显示"正在加载编辑器..."提示
- ✅ ONLYOFFICE编辑器加载成功
- ✅ 文档内容正常显示
- ✅ 可以滚动查看文档
- ✅ 工具栏显示正常

**可能的问题**:
- ❌ 如果显示"编辑器初始化失败"：检查ONLYOFFICE服务是否可访问
- ❌ 如果显示"无法预览该文件"：检查后端代理端点是否正常
- ❌ 如果显示空白：检查浏览器控制台错误

**测试结果**: ⬜ 通过 / ⬜ 失败

**备注**:
```
[在此记录测试结果和问题]
```

---

### 测试2: 文书生成预览 ⏳

**目标**: 验证文书生成后的ONLYOFFICE预览

**步骤**:
1. 进入"文书生成"页面
2. 选择一个模板（如"信访答复函"）
3. 输入需求："生成一份关于道路维修的答复函"
4. 点击"发送"按钮
5. 等待AI生成完成
6. 观察右侧预览区

**预期结果**:
- ✅ 左侧显示AI对话
- ✅ 右侧显示ONLYOFFICE编辑器
- ✅ 生成的文书内容正常显示
- ✅ 可以滚动查看文书
- ✅ 格式正确（标题、正文、落款等）

**可能的问题**:
- ❌ 如果右侧显示空白：检查文档ID是否正确
- ❌ 如果显示"预览加载失败"：检查后端预览API
- ❌ 如果生成失败：检查DeepSeek API配置

**测试结果**: ⬜ 通过 / ⬜ 失败

**备注**:
```
[在此记录测试结果和问题]
```

---

### 测试3: 文书查看功能 ⏳

**目标**: 验证文书管理页面的ONLYOFFICE预览

**步骤**:
1. 进入"文书管理"页面
2. 找到之前生成的文书
3. 点击"查看"按钮
4. 观察预览对话框

**预期结果**:
- ✅ 对话框打开
- ✅ 显示文书基本信息（标题、类型、状态、密级等）
- ✅ ONLYOFFICE编辑器加载成功
- ✅ 文书内容正常显示
- ✅ 可以滚动查看
- ✅ "下载文书"按钮可用

**可能的问题**:
- ❌ 如果显示文本内容而非编辑器：检查预览类型检测
- ❌ 如果显示"无法加载预览"：检查文档预览API

**测试结果**: ⬜ 通过 / ⬜ 失败

**备注**:
```
[在此记录测试结果和问题]
```

---

### 测试4: 文书在线编辑 ⏳

**目标**: 验证ONLYOFFICE在线编辑功能

**步骤**:
1. 在"文书管理"页面
2. 点击文书的"在线编辑"按钮
3. 观察编辑对话框
4. 尝试编辑文档内容
5. 点击保存

**预期结果**:
- ✅ 编辑对话框打开（全屏）
- ✅ ONLYOFFICE编辑器加载（编辑模式）
- ✅ 工具栏显示完整（格式、插入、审阅等）
- ✅ 可以编辑文档内容
- ✅ 可以修改格式
- ✅ 保存成功提示
- ✅ 对话框关闭
- ✅ 文书列表刷新

**可能的问题**:
- ❌ 如果工具栏不可用：检查编辑模式配置
- ❌ 如果无法保存：检查回调URL配置
- ❌ 如果保存后内容未更新：检查后端保存逻辑

**测试结果**: ⬜ 通过 / ⬜ 失败

**备注**:
```
[在此记录测试结果和问题]
```

---

### 测试5: 文件研判预览 ⏳

**目标**: 验证文件研判页面的ONLYOFFICE预览

**步骤**:
1. 进入"文件管理"页面
2. 点击文件的"研判"按钮
3. 观察左侧预览区
4. 点击"开始研判"按钮
5. 等待AI研判完成
6. 观察右侧研判结果

**预期结果**:
- ✅ 左侧ONLYOFFICE编辑器加载成功
- ✅ 文件内容正常显示
- ✅ 点击"开始研判"后，左侧预览不受影响
- ✅ 右侧显示AI研判结果
- ✅ 研判结果包含总体评价和问题列表
- ✅ 可以同时查看文件和研判结果

**可能的问题**:
- ❌ 如果左侧显示"ONLYOFFICE预览功能正在开发中"：说明前端未正确集成
- ❌ 如果研判失败：检查AI服务配置
- ❌ 如果预览和研判互相干扰：检查组件状态管理

**测试结果**: ⬜ 通过 / ⬜ 失败

**备注**:
```
[在此记录测试结果和问题]
```

---

### 测试6: 降级策略验证 ⏳

**目标**: 验证ONLYOFFICE不可用时的降级行为

**步骤**:
1. 暂时停止ONLYOFFICE服务（或修改配置）
2. 尝试预览文件
3. 观察降级行为

**预期结果**:
- ✅ 系统自动降级到华为云预览
- ✅ 或显示友好的错误提示
- ✅ 提供下载文件选项
- ✅ 其他功能不受影响

**可能的问题**:
- ❌ 如果系统崩溃：检查错误处理
- ❌ 如果没有降级：检查预览服务选择器

**测试结果**: ⬜ 通过 / ⬜ 失败

**备注**:
```
[在此记录测试结果和问题]
```

---

## 🐛 常见问题排查

### 问题1: ONLYOFFICE编辑器不显示

**症状**: 预览对话框打开，但只显示加载中或空白

**可能原因**:
1. ONLYOFFICE服务不可访问
2. API脚本加载失败
3. 配置错误

**排查步骤**:
1. 检查浏览器控制台错误
2. 访问 http://101.37.24.171:9090/healthcheck
3. 检查后端配置：`backend/.env`
4. 检查网络连接

**解决方案**:
```bash
# 检查ONLYOFFICE服务
curl http://101.37.24.171:9090/healthcheck

# 检查后端配置
cat backend/.env | grep ONLYOFFICE

# 重启后端服务（如果需要）
# 在backend目录执行：python run.py
```

---

### 问题2: 编辑器显示但文档内容为空

**症状**: ONLYOFFICE编辑器加载成功，但文档内容为空

**可能原因**:
1. 文件URL不可访问
2. 后端代理端点问题
3. MinIO服务问题

**排查步骤**:
1. 检查后端日志
2. 测试代理端点：`/api/v1/onlyoffice/download/file/{file_id}`
3. 检查MinIO服务状态

**解决方案**:
```bash
# 测试代理端点
curl http://localhost:8000/api/v1/onlyoffice/download/file/7

# 检查MinIO连接
# 查看后端日志中的MinIO相关信息
```

---

### 问题3: 编辑模式工具栏不可用

**症状**: 编辑器打开，但工具栏按钮灰色不可点击

**可能原因**:
1. 权限配置错误
2. 编辑模式未正确设置
3. 文档锁定

**排查步骤**:
1. 检查编辑器配置中的mode参数
2. 检查用户权限
3. 查看ONLYOFFICE控制台日志

**解决方案**:
```typescript
// 确认mode参数正确
<OnlyOfficeEditor
  :document-id="documentId"
  mode="edit"  // 确保是"edit"而不是"view"
  ...
/>
```

---

### 问题4: 保存失败

**症状**: 编辑文档后点击保存，显示保存失败

**可能原因**:
1. 回调URL配置错误
2. 后端回调处理失败
3. 文件权限问题

**排查步骤**:
1. 检查后端日志中的回调请求
2. 测试回调端点：`/api/v1/onlyoffice/callback`
3. 检查文件写入权限

**解决方案**:
```bash
# 检查回调URL配置
cat backend/.env | grep CALLBACK

# 查看后端日志
# 搜索 "callback" 相关日志
```

---

## 📊 测试结果汇总

### 测试统计

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 文件预览 | ⬜ | |
| 文书生成预览 | ⬜ | |
| 文书查看 | ⬜ | |
| 文书在线编辑 | ⬜ | |
| 文件研判预览 | ⬜ | |
| 降级策略 | ⬜ | |

**总计**: 0/6 通过

---

## 📝 测试报告模板

### 测试环境
- 操作系统: Windows
- 浏览器: [填写浏览器和版本]
- 后端版本: [填写]
- 前端版本: [填写]
- ONLYOFFICE版本: [填写]

### 测试结果
- 通过: X 项
- 失败: X 项
- 跳过: X 项

### 发现的问题
1. [问题描述]
   - 严重程度: 高/中/低
   - 复现步骤: [步骤]
   - 预期结果: [描述]
   - 实际结果: [描述]
   - 截图: [如果有]

### 改进建议
1. [建议1]
2. [建议2]

### 测试结论
[总体评价和建议]

---

## 🔗 相关文档

- [ONLYOFFICE前端集成完成](docs/development/ONLYOFFICE前端集成完成.md)
- [ONLYOFFICE测试状态](ONLYOFFICE测试状态-最新.md)
- [ONLYOFFICE集成完成总结](ONLYOFFICE集成完成总结.md)
- [ONLYOFFICE快速参考卡](ONLYOFFICE快速参考卡.md)

---

**测试人员**: [填写]  
**测试日期**: 2026-01-03  
**文档版本**: 1.0
