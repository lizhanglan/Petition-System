# 文档预览与编辑功能重构解决方案

## 背景

当前系统使用WPS和华为云服务进行文档预览，存在以下问题：
- WPS服务不稳定，API端点返回404
- 华为云服务仅支持预览，不支持在线编辑
- 缺乏统一的文档协作编辑能力
- 预览服务切换逻辑复杂

## 解决方案

**使用ONLYOFFICE社区版**替代现有预览服务，实现统一的文档预览和在线编辑功能。

### ONLYOFFICE服务信息
- **部署方式**：Docker部署在阿里云
- **公网地址**：`http://101.37.24.171:9090`
- **版本**：社区版（Community Edition）
- **支持格式**：DOCX, XLSX, PPTX, PDF等

## 核心优势

1. **统一服务**：预览和编辑使用同一服务，简化架构
2. **在线编辑**：支持Word、Excel、PPT在线编辑
3. **协作功能**：支持多人同时编辑（可选）
4. **版本控制**：自动保存和版本管理
5. **开源免费**：社区版免费使用
6. **稳定可靠**：成熟的开源项目，广泛应用

## 技术架构

```
┌─────────────┐
│  用户浏览器  │
└──────┬──────┘
       │
       ├─────────────────┐
       │                 │
       ▼                 ▼
┌─────────────┐   ┌──────────────┐
│ FastAPI后端 │   │  ONLYOFFICE  │
│             │◄──┤    Server    │
│  - 配置生成  │   │ 101.37.24.171│
│  - 权限验证  │   │     :9090    │
│  - 回调处理  │   └──────────────┘
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   MinIO     │
│  文件存储    │
└─────────────┘
```

## 重构范围

### 后端改造
1. 创建ONLYOFFICE服务类
2. 实现JWT token生成和验证
3. 创建API端点（配置、回调、下载）
4. 更新预览服务选择器
5. 移除WPS服务代码

### 前端改造
1. 创建ONLYOFFICE编辑器组件
2. 更新文件预览页面
3. 更新文书生成预览
4. 更新文书管理页面
5. 更新文件研判页面

### 功能增强
1. 版本管理集成
2. 协作编辑支持（可选）
3. 性能优化
4. 错误处理完善

## 实施计划

### 阶段一：环境准备（1天）
- 验证ONLYOFFICE服务
- 生成JWT密钥
- 配置环境变量

### 阶段二：后端开发（3天）
- 创建服务类和API端点
- 更新预览服务选择器
- 实现回调处理

### 阶段三：前端开发（3天）
- 创建编辑器组件
- 更新各个页面
- 集成测试

### 阶段四：功能增强（2天）
- 版本管理
- 协作编辑
- 性能优化

### 阶段五：清理和测试（2天）
- 移除旧代码
- 全面测试
- 文档更新

### 阶段六：部署上线（1天）
- 生产环境配置
- 部署验证
- 监控和优化

**总计：11-16天**

## 关键配置

### 环境变量
```bash
# ONLYOFFICE配置
ONLYOFFICE_ENABLED=true
ONLYOFFICE_SERVER_URL=http://101.37.24.171:9090
ONLYOFFICE_JWT_SECRET=生成的密钥
ONLYOFFICE_JWT_ENABLED=true
ONLYOFFICE_CALLBACK_URL=http://你的后端/api/v1/onlyoffice/callback
```

### 编辑器配置示例
```json
{
  "document": {
    "fileType": "docx",
    "key": "unique_key",
    "title": "文档.docx",
    "url": "http://backend/download/file",
    "permissions": {
      "edit": true,
      "download": true
    }
  },
  "documentType": "word",
  "editorConfig": {
    "mode": "edit",
    "lang": "zh-CN",
    "callbackUrl": "http://backend/callback",
    "user": {
      "id": "user_123",
      "name": "张三"
    }
  },
  "token": "jwt_token"
}
```

## 数据流程

### 预览流程
1. 用户点击"预览"
2. 前端请求编辑器配置
3. 后端生成配置（包含文件URL和JWT token）
4. 前端初始化ONLYOFFICE编辑器
5. ONLYOFFICE从MinIO下载文件并显示

### 编辑流程
1. 用户点击"编辑"
2. 前端请求编辑配置（mode=edit）
3. 用户在ONLYOFFICE中编辑
4. 用户保存，ONLYOFFICE调用回调接口
5. 后端从ONLYOFFICE下载编辑后的文件
6. 后端保存到MinIO并创建新版本
7. 返回成功响应

## 安全措施

1. **JWT验证**：所有请求必须包含有效token
2. **权限控制**：验证用户访问权限
3. **文件隔离**：用户只能访问自己的文件
4. **回调验证**：验证回调来源
5. **HTTPS**：生产环境使用HTTPS

## 降级策略

保留华为云服务作为降级方案：
```
优先级：
1. ONLYOFFICE（主要服务）
2. 华为云（降级服务，仅预览）
3. 直接URL（PDF文件）
```

## 详细文档

- **完整方案**：`docs/development/ONLYOFFICE重构方案.md`
- **任务清单**：`docs/development/ONLYOFFICE重构任务清单.md`
- **快速开始**：`docs/development/ONLYOFFICE快速开始指南.md`

## 预期效果

### 用户体验
- ✅ 统一的预览和编辑界面
- ✅ 流畅的在线编辑体验
- ✅ 自动保存，不丢失数据
- ✅ 支持多种文档格式

### 技术收益
- ✅ 简化系统架构
- ✅ 降低维护成本
- ✅ 提高系统稳定性
- ✅ 增强功能扩展性

### 业务价值
- ✅ 提升工作效率
- ✅ 改善用户满意度
- ✅ 支持协作办公
- ✅ 降低运营成本

## 风险评估

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| ONLYOFFICE服务不稳定 | 高 | 中 | 保留华为云降级 |
| JWT配置错误 | 高 | 低 | 详细文档和验证 |
| 文件保存失败 | 高 | 低 | 重试机制 |
| 性能问题 | 中 | 中 | 缓存和优化 |

## 下一步行动

1. **立即开始**：阅读快速开始指南
2. **验证服务**：测试ONLYOFFICE可用性
3. **配置环境**：设置JWT和环境变量
4. **开发MVP**：实现最小可行版本
5. **测试验证**：确保功能正常
6. **全面推广**：更新所有相关页面

## 参考资源

- [ONLYOFFICE官网](https://www.onlyoffice.com/)
- [ONLYOFFICE API文档](https://api.onlyoffice.com/)
- [集成示例](https://github.com/ONLYOFFICE/document-server-integration)
- [JWT规范](https://jwt.io/)

## 联系支持

如有问题，请查看详细文档或联系开发团队。
