# ONLYOFFICE修复 - 快速部署指南

## 当前状态
✅ 代码已修复（本地）
❌ 服务器代码未更新
❌ 服务器前端未重新构建

## 快速部署（3步）

### 步骤1: 推送代码
```bash
# 在本地执行
git add .
git commit -m "修复ONLYOFFICE编辑器加载问题：修复response.data和文件下载端点"
git push origin main
```

### 步骤2: 登录服务器
```bash
ssh user@101.37.24.171
```

### 步骤3: 运行部署脚本
```bash
cd /opt/petition-system
sudo bash deploy-server.sh
```

部署脚本会自动：
- ✅ 拉取最新代码（git pull）
- ✅ 安装Python依赖
- ✅ 重启后端服务
- ✅ 安装Node.js依赖
- ✅ **构建前端（npm run build）** ← 这会应用修复
- ✅ 重启Nginx

## 验证修复

### 1. 检查服务状态
```bash
# 在服务器上
sudo systemctl status petition-backend
sudo systemctl status nginx
```

### 2. 测试下载端点
```bash
# 在服务器上
curl -I http://101.37.24.171:8000/api/v1/onlyoffice/download/file/5

# 应该返回：
# HTTP/1.1 200 OK
# Content-Type: application/pdf
```

### 3. 测试前端
1. 访问：http://101.37.24.171
2. 登录系统
3. 进入文件管理
4. 点击预览
5. **不应该再看到 "Editor config: undefined" 错误**
6. 编辑器应该正常加载文档

## 如果还有问题

### 清除浏览器缓存
```
Ctrl + Shift + Delete（Windows）
Cmd + Shift + Delete（Mac）
```

或使用隐私模式/无痕模式访问

### 查看后端日志
```bash
# 在服务器上
sudo journalctl -u petition-backend -n 100 -f
```

应该看到：
```
[OnlyOffice] ========== Download Request ==========
[OnlyOffice] File ID: 5
[OnlyOffice] SUCCESS: File downloaded from MinIO, size: 189495 bytes
```

### 查看Nginx日志
```bash
sudo tail -f /var/log/nginx/error.log
```

## 修复内容总结

### 前端修复
**文件**: `frontend/src/components/OnlyOfficeEditor.vue`

**问题**: 直接使用Axios响应对象，而不是响应数据
```javascript
// 错误
const config = await request.post(...)
config.events = { ... }  // config是AxiosResponse对象

// 正确
const response = await request.post(...)
const config = response.data  // 使用response.data
config.events = { ... }
```

### 后端修复
**文件**: `backend/app/api/v1/endpoints/onlyoffice.py`

**问题1**: File模型没有content_type字段
```python
# 添加MIME类型映射
mime_types = {
    'pdf': 'application/pdf',
    'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    # ...
}
```

**问题2**: 中文文件名编码错误
```python
# 使用UTF-8编码
from urllib.parse import quote
encoded_filename = quote(file.file_name)
"Content-Disposition": f"attachment; filename*=UTF-8''{encoded_filename}"
```

## 预期结果

部署完成后：
- ✅ 编辑器配置正确加载（不再是undefined）
- ✅ 文档下载成功（200 OK）
- ✅ ONLYOFFICE编辑器正常显示文档内容
- ✅ 支持中文文件名
- ✅ 支持PDF、DOC、DOCX等格式

## 时间估计
- 推送代码: 1分钟
- 登录服务器: 1分钟
- 运行部署脚本: 5-10分钟（取决于网络速度）
- 验证功能: 2分钟

**总计**: 约10-15分钟

---

**修复日期**: 2026-01-03  
**修复版本**: v1.0.1  
**关键修复**: 前端response.data + 后端文件下载端点
